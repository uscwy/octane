/* sample.cpp */
/*
 * sample code to open tunnel interface and to read data from it.
 */

/*
* This code "USC CSci551 FA2012 Projects A and B" is
* Copyright (C) 2012 by Zi Hu.
* All rights reserved.
*
* This program is released ONLY for the purposes of Fall 2012 CSci551
* students who wish to use it as part of their project assignments.
* Use for another other purpose requires prior written approval by
* Zi Hu.
*
* Use in CSci551 is permitted only provided that ALL copyright notices
* are maintained and that this code is distinguished from new
* (student-added) code as much as possible.  We new services to be
* placed in separate (new) files as much as possible.  If you add
* significant code to existing files, identify your new code with
* comments.
*
* As per class assignments, use of any code OTHER than this provided
* code requires explicit approval, ahead of time, by the professor.
*
*/


#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <linux/if_tun.h>
#include <sys/ioctl.h>
#include <net/if.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <arpa/inet.h>
#include <fcntl.h>
#include <unistd.h>

/**************************************************************************
 * tun_alloc: allocates or reconnects to a tun/tap device. 
 * copy from from simpletun.c
 * refer to http://backreference.org/2010/03/26/tuntap-interface-tutorial/ for more info 
 **************************************************************************/

int tun_alloc(char *dev) 
{
    struct ifreq ifr;
    int fd, err;
    char *clonedev = (char*)"/dev/net/tun";

    if( (fd = open(clonedev , O_RDWR)) < 0 ) 
    {
	perror("Opening /dev/net/tun");
	return fd;
    }

    memset(&ifr, 0, sizeof(ifr));

    ifr.ifr_flags = IFF_TUN | IFF_NO_PI;

    if (*dev) 
    {
	strncpy(ifr.ifr_name, dev, IFNAMSIZ);
    }

    if( (err = ioctl(fd, TUNSETIFF, (void *)&ifr)) < 0 ) 
    {
	perror("ioctl(TUNSETIFF)");
	close(fd);
	return err;
    }

    strcpy(dev, ifr.ifr_name);
    return fd;
}
int tun_write(int tun_fd, char *buf, int len)
{
    return write(tun_fd, buf, len);
}
int tun_read(int tun_fd, char *buf, int buf_len)
{
    /*char tun_name[IFNAMSIZ];*/

    /* Connect to the tunnel interface (make sure you create the tunnel interface first) */
    /*
    strcpy(tun_name, "tun1");
    int tun_fd = tun_alloc(tun_name, IFF_TUN | IFF_NO_PI); 

    if(tun_fd < 0)
    {
	perror("Open tunnel interface");
	return 1;
    }
    */

    /*
     * This loop reads packets from the tunnle interface.
     *
     * You will need to REWRITE this loop into a select loop,
     * so that it can talk both to the tun interface,
     * AND to the router.
     *
     * You will also probably want to do other setup in the
     * main() routine.
     */
    /* Now read data coming from the tunnel */
    int nread = read(tun_fd,buf, buf_len);
    if(nread < 0) 
    {
        perror("Reading from tunnel interface");
        return -1;
    }

    printf("Read a packet from tunnel, packet length:%d\n", nread);

    return nread;
    /* Do whatever with the data, function to manipulate the data here */

    /*
    * For project A, you will need to add code to forward received packet 
    * to router via UDP socket.
    * And when you get icmp echo reply packet from router, you need to write        * it back to the tunnel interface 
    */    
}

